<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gateway Router</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
    }
    label {
      display: block;
      margin-top: 15px;
    }
    select, input[type="text"], button {
      width: 300px;
      padding: 8px;
      margin-top: 5px;
    }
    #result {
      margin-top: 20px;
      font-weight: bold;
    }
    pre {
      background: #f4f4f4;
      padding: 10px;
      border-radius: 5px;
    }
  </style>
</head>
<body>

  <h2>Transaction Gateway Router</h2>

  <form id="gatewayForm">
    <label for="paymentType">Payment Type</label>
    <select id="paymentType">
      <option value="VI">VI</option>
      <option value="MC">MC</option>
      <option value="AX">AX</option>
      <option value="PPL">PPL</option>
      <option value="KLI">KLI</option>
    </select>

    <label for="currency">Currency</label>
    <select id="currency">
      <option value="USD">USD</option>
      <option value="EUR">EUR</option>
      <option value="GBP">GBP</option>
      <option value="CAD">CAD</option>
      <option value="AUD">AUD</option>
      <option value="PLN">PLN</option>
      <!-- Easily extensible -->
    </select>

    <label for="selector">Gateway Selector Logic</label>
    <input type="text" id="selector" placeholder="Enter selector logic">

    <button type="submit">Route Transaction</button>
  </form>

  <div id="result"></div>
  <pre id="debug"></pre>

  <script>
    const cardTypeMap = {
      VI: '001',
      MC: '002',
      AX: '003',
      PPL: '004',
      KLI: '005'
    };

    document.getElementById('gatewayForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const acct_subtype = document.getElementById('paymentType').value;
      const ap_payment_type = acct_subtype;
      const currency = document.getElementById('currency').value;
      const card_type = cardTypeMap[acct_subtype];
      const selector = document.getElementById('selector').value;

      const REQ = { acct_subtype, ap_payment_type, currency, card_type };

      const gateway = evaluateSelector(selector, REQ);
      document.getElementById('result').textContent = `Routed to: ${gateway}`;
    });

    function evaluateSelector(selector, REQ) {
      const parts = selector.split(',');
      let defaultGateway = parts[parts.length - 1];
      let matchedGateway = null;
      let debugOutput = `Evaluating with REQ: ${JSON.stringify(REQ, null, 2)}\n\n`;

      for (let i = 0; i < parts.length; i++) {
        const part = parts[i];
        const [condition, gateway] = part.split(':');

        if (!gateway) continue;

        let expr = condition.replace(/\{REQ\.(\w+)\}/g, (_, key) => {
          return `"${REQ[key]}"`;
        });

        expr = expr
          .replace(/=/g, '===')
          .replace(/\|/g, '||')
          .replace(/&/g, '&&')
          .replace(/(?<!")\b([A-Z0-9]+)\b(?!")/g, '"$1"'); // Quote unquoted literals

        debugOutput += `Rule ${i + 1}: ${condition} => ${expr}\n`;

        try {
          if (eval(expr)) {
            matchedGateway = gateway;
            debugOutput += `Matched: ${gateway}\n---\n`;
            break;
          } else {
            debugOutput += `Not matched\n---\n`;
          }
        } catch (err) {
          debugOutput += `Error evaluating: ${err.message}\n---\n`;
        }
      }

      debugOutput += `Final Gateway: ${matchedGateway || defaultGateway}`;
      document.getElementById('debug').textContent = debugOutput;

      return matchedGateway || defaultGateway;
    }
  </script>

</body>
</html>